<!-- Google Fonts: Inter for body text, JetBrains Mono for code -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

<!-- KaTeX for math rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" onload="initKaTeX()"></script>

<!-- TikZJax for TikZ rendering -->
<link rel="stylesheet" type="text/css" href="https://tikzjax.pages.dev/fonts.css">
<script src="https://tikzjax.pages.dev/tikzjax.js"></script>

<!-- TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>

<!-- Custom styles for math and interactive components -->
<style>
  .math-block {
    overflow-x: auto;
    margin: 1rem 0;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    position: relative;
  }
  .copy-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    padding: 0.25rem 0.5rem;
    background-color: #e2e8f0;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    cursor: pointer;
  }
  .tf-container {
    margin: 2rem 0;
    padding: 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
  }
  .tikz-container {
    display: flex;
    justify-content: center;
    margin: 1.5rem 0;
  }
</style>


<script>
// ============================================
// Dark Mode System
// ============================================

// Prevent flash of unstyled content
document.documentElement.classList.add('preload');

// Initialize dark mode immediately
(function() {
  const savedMode = localStorage.getItem('darkMode');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

  // Use saved preference, or fall back to system preference
  if (savedMode === 'true' || (savedMode === null && prefersDark)) {
    document.body.classList.add('dark-mode');
  }

  // Remove preload class after a short delay
  setTimeout(() => {
    document.documentElement.classList.remove('preload');
  }, 100);
})();

// Update button icon based on current mode
function updateToggleButton() {
  const isDark = document.body.classList.contains('dark-mode');
  const themeIcon = document.getElementById('theme-icon');
  if (themeIcon) {
    themeIcon.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
  }
  const toggleBtn = document.getElementById('dark-mode-toggle');
  if (toggleBtn) {
    toggleBtn.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
  }
}

// Toggle function (called by button onclick)
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode', isDark);
  updateToggleButton();
}

// Update button icon when page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', updateToggleButton);
} else {
  updateToggleButton();
}

// Listen for system theme changes
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
  if (localStorage.getItem('darkMode') === null) {
    if (e.matches) {
      document.body.classList.add('dark-mode');
    } else {
      document.body.classList.remove('dark-mode');
    }
    updateToggleButton();
  }
});

// ============================================
// KaTeX Math Rendering
// ============================================

function initKaTeX() {
  if (typeof renderMathInElement !== 'undefined') {
    renderMathInElement(document.body, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\[", right: "\\]", display: true},
        {left: "\\(", right: "\\)", display: false}
      ],
      throwOnError: false,
      strict: false
    });
  }
}

// ============================================
// Code Block Copy Buttons
// ============================================

function addCopyButtonsToCodeBlocks() {
  // Find all code blocks
  const codeBlocks = document.querySelectorAll('.main-content .highlight, .main-content pre');

  console.log('Found code blocks:', codeBlocks.length);

  codeBlocks.forEach((block, index) => {
    // Skip if already has a copy button or is inside a .highlight
    if (block.querySelector('.code-copy-btn')) {
      console.log('Block', index, 'already has button');
      return;
    }

    if (block.tagName === 'PRE' && block.parentElement.classList.contains('highlight')) {
      console.log('Block', index, 'is inside .highlight, skipping');
      return;
    }

    console.log('Adding button to block', index);

    // Create container
    const container = document.createElement('div');
    container.className = 'code-copy-container';

    // Create copy button with SVG icons
    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-copy-btn';
    copyBtn.setAttribute('aria-label', 'Copy to clipboard');
    copyBtn.setAttribute('data-tooltip', 'Copy');

    // Copy icon SVG (two overlapping squares)
    copyBtn.innerHTML = `
      <svg class="copy-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M12.5 3C13.3284 3 14 3.67157 14 4.5V6H15.5C16.3284 6 17 6.67157 17 7.5V15.5C17 16.3284 16.3284 17 15.5 17H7.5C6.67157 17 6 16.3284 6 15.5V14H4.5C3.67157 14 3 13.3284 3 12.5V4.5C3 3.67157 3.67157 3 4.5 3H12.5ZM14 12.5C14 13.3284 13.3284 14 12.5 14H7V15.5C7 15.7761 7.22386 16 7.5 16H15.5C15.7761 16 16 15.7761 16 15.5V7.5C16 7.22386 15.7761 7 15.5 7H14V12.5ZM4.5 4C4.22386 4 4 4.22386 4 4.5V12.5C4 12.7761 4.22386 13 4.5 13H12.5C12.7761 13 13 12.7761 13 12.5V4.5C13 4.22386 12.7761 4 12.5 4H4.5Z"></path>
      </svg>
      <svg class="check-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M15.1883 5.10908C15.3699 4.96398 15.6346 4.96153 15.8202 5.11592C16.0056 5.27067 16.0504 5.53125 15.9403 5.73605L15.8836 5.82003L8.38354 14.8202C8.29361 14.9279 8.16242 14.9925 8.02221 14.9989C7.88203 15.0051 7.74545 14.9526 7.64622 14.8534L4.14617 11.3533L4.08172 11.2752C3.95384 11.0811 3.97542 10.817 4.14617 10.6463C4.31693 10.4755 4.58105 10.4539 4.77509 10.5818L4.85321 10.6463L7.96556 13.7586L15.1161 5.1794L15.1883 5.10908Z"></path>
      </svg>
    `;

    // Add click handler
    copyBtn.addEventListener('click', function(e) {
      e.preventDefault();

      // Find the code element
      const codeElement = block.querySelector('code') || block;
      if (!codeElement) return;

      // Get the code text
      const codeText = codeElement.textContent;

      // Copy to clipboard
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(codeText).then(() => {
          copyBtn.classList.add('copied');
          copyBtn.setAttribute('data-tooltip', 'Copied!');
          setTimeout(() => {
            copyBtn.classList.remove('copied');
            copyBtn.setAttribute('data-tooltip', 'Copy');
          }, 2000);
        }).catch(err => {
          console.error('Failed to copy:', err);
        });
      } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = codeText;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          copyBtn.classList.add('copied');
          copyBtn.setAttribute('data-tooltip', 'Copied!');
          setTimeout(() => {
            copyBtn.classList.remove('copied');
            copyBtn.setAttribute('data-tooltip', 'Copy');
          }, 2000);
        } catch (err) {
          console.error('Fallback copy failed:', err);
        }
        document.body.removeChild(textArea);
      }
    });

    // Make sure block is positioned
    const position = window.getComputedStyle(block).position;
    if (position === 'static') {
      block.style.position = 'relative';
    }

    container.appendChild(copyBtn);
    block.appendChild(container);
  });
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    addCopyButtonsToCodeBlocks();
    if (typeof renderMathInElement === 'undefined') {
      // KaTeX not loaded yet, will be called by onload
      console.log('KaTeX not ready, waiting...');
    } else {
      initKaTeX();
    }
  });
} else {
  // DOM already loaded
  addCopyButtonsToCodeBlocks();
  if (typeof renderMathInElement !== 'undefined') {
    initKaTeX();
  }
}
</script>